# Test Results Aggregator

A Python module for aggregating, analyzing, and visualizing Keycloak benchmark test results. This module processes raw test result data from multiple benchmark runs and generates comprehensive statistics and reports.

## Overview

The Test Results Aggregator processes JSON result files generated by the Keycloak Benchmark tool, performs statistical analysis, and outputs aggregated reports in both JSON and HTML formats. It's designed to handle multiple test instances and provide a consolidated view of performance metrics.

## Dependencies

### Required Dependencies
- Python 3.6+
- Standard library modules: `os`, `json`, `shutil`, `glob`, `collections`

### Optional Dependencies
- **BeautifulSoup4** (`beautifulsoup4`): Used for precise HTML content manipulation in aggregated reports
  - **When available**: Enables smart HTML content replacement (updating titles, scenario names, etc.)
  - **When unavailable**: Falls back to simple file copying with basic functionality
  - **Installation**: `pip install beautifulsoup4`

The module implements graceful degradation - it will function correctly with or without BeautifulSoup4, though some HTML customization features may be limited in environments where it's not available.

## Architecture

```
                                                  +-------------------+
                                                  |                   |
                          +-------------------+   |  HTML Reports     |
                          |                   |   |  (visualization)  |
                          |  Result Files     |   |                   |
                          |  (JSON)           |   +-------------------+
                          |                   |             ^
                          +--------+----------+             |
                                   |                        |
                                   v                        |
+---------------+        +-------------------+     +--------+----------+
|               |        |                   |     |                   |
| Command Line  +------->+  ResultsAggregator+---->+  Reporters       |
| Interface     |        |  (Core Engine)    |     |  (Output)        |
|               |        |                   |     |                   |
+---------------+        +-------------------+     +--------+----------+
                                   ^                        |
                                   |                        |
                          +--------+----------+             |
                          |                   |             v
                          |  Data Models      |    +-------------------+
                          |  (Parsing)        |    |                   |
                          |                   |    |  JSON Summary     |
                          +-------------------+    |  (Data)           |
                                                   |                   |
                                                   +-------------------+
```

## Components

| Module | Description |
|--------|-------------|
| `models.py` | Data models and structures for representing benchmark statistics and test results. Handles parsing of JSON result files. |
| `aggregator.py` | Core aggregation engine that finds relevant files, computes statistics, and manages the overall aggregation process. |
| `reporters.py` | Output generators for various report formats (JSON, HTML, JavaScript). Includes intelligent HTML content manipulation using BeautifulSoup4 when available, with graceful fallback to basic file operations. |
| `utils.py` | Utility functions for file operations, data formatting, and other helper tasks. |
| `main.py` | Command-line interface implementation and entry point for the module. |
| `run.py` | Lightweight entry script for executing the module as a standalone tool. |
| `__init__.py` | Package initialization, metadata, and exports. |

## Key Classes

### `TestResult` (models.py)
Represents a single test result, with methods to parse JSON files and extract relevant metrics.

### `BenchmarkStat` (models.py)
Statistical container for performance metrics like response times, throughput, and percentiles.

### `ResultsAggregator` (aggregator.py)
The core engine that discovers test result files, aggregates statistics, and provides analysis methods.

### `JsonReporter`, `HtmlReporter`, `JavaScriptReporter` (reporters.py)
Report generators for different output formats.

## Workflow

1. **Discovery**: Find relevant test result files matching the specified scenario
2. **Parsing**: Read and parse JSON result files into TestResult objects
3. **Aggregation**: Combine metrics from multiple test results
4. **Statistical Analysis**: Calculate averages, percentiles, and other statistics
5. **Reporting**: Generate output reports in requested formats

## Installation

### Basic Installation
The module uses only Python standard library modules for core functionality:

```bash
# No additional installation required for basic functionality
python -m test_results_aggregator.run <scenario>
```

### Enhanced Installation (Recommended)
For full HTML customization features, install the optional BeautifulSoup4 dependency:

```bash
pip install beautifulsoup4
```

This enables:
- Intelligent HTML title updates with correct scenario names
- Customized report headers and navigation elements  
- Enhanced HTML content manipulation in aggregated reports

### Environment Compatibility
The module automatically detects available dependencies and adjusts functionality accordingly:
- **Production environments**: Can run with minimal dependencies
- **Development environments**: Benefits from enhanced features with BeautifulSoup4
- **CI/CD pipelines**: Gracefully handles missing optional dependencies

## Usage

The module can be used in two ways:

### 1. As a command-line tool:

```bash
python -m test_results_aggregator.run <scenario> [options]
```

Where `<scenario>` is the suffix of the Keycloak benchmark test scenario name. The aggregator extracts this from the result directory names, which match the scenario name used during testing.

For example, if you ran tests with the scenario `keycloak.scenario.authentication.AuthorizationCode`, you would use:
```bash
python -m test_results_aggregator.run authorizationcode
```

The available Keycloak test scenarios can be found in the [Keycloak Benchmark documentation](https://www.keycloak.org/keycloak-benchmark/benchmark-guide/latest/scenario-overview). The aggregator uses the last segment of the full scenario path (converted to lowercase) as the identifier.

Common scenario suffixes include:
- `authorizationcode` - OAuth2 Authorization Code flow
- `loginuserpassword` - Browser login flow
- `clientsecret` - Client Credentials Grant
- `createrealms` - Create realms admin operation

### 2. As a Python library:

```python
from test_results_aggregator.aggregator import ResultsAggregator
from test_results_aggregator.reporters import JsonReporter

# Create aggregator
aggregator = ResultsAggregator("authorizationcode", "./results")

# Process results
aggregator.find_result_files()
aggregator.aggregate_results()

# Output report
reporter = JsonReporter(aggregator)
reporter.export_json_summary("result_summary.json")
```

## Output Formats

1. **Console Output**: Text-based summary of aggregated results
2. **JSON Summary**: Structured data ideal for programmatic processing
3. **HTML Report**: Interactive dashboard with charts and detailed metrics
   - **Enhanced Mode** (with BeautifulSoup4): Intelligently updates HTML content with correct scenario names, titles, and customized elements
   - **Basic Mode** (without BeautifulSoup4): Copies template files with original content, all visualization features remain functional
4. **JavaScript Data**: Exportable data for custom visualizations 